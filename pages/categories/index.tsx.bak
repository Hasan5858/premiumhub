import { useState, useEffect } from "react"
import Head from "next/head"
import Link from "next/link"
import { Grid3x3, Search } from "lucide-react"
import { fetchAllProviderCategories } from "@/services/api"
import { getCacheItem, setCacheItem } from "@/services/cache"
import { useAuth } from "@/contexts/AuthContext"
import PremiumBadge from "@/components/PremiumBadge"

interface ProviderCategory {
  name: string
  url: string
  count?: number
  thumbnail?: string
  provider?: string
}

export default function CategoriesPage() {
  const [categories, setCategories] = useState<ProviderCategory[]>([])
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [searchQuery, setSearchQuery] = useState("")
  const { user } = useAuth()

  // Check if user has premium access
  const hasPremiumAccess =
    user &&
    (user.membership_status === "monthly" ||
      user.membership_status === "3month" ||
      user.membership_status === "halfyearly" ||
      user.membership_status === "yearly" ||
      user.membership_status === "admin")

  const loadAllCategories = async () => {
    setLoading(true)
    try {
      setError(null)

      // Load IndianPornHQ categories
      const result = await fetchAllProviderCategories()
      let allCategories: ProviderCategory[] = []

      if (result.success && result.data && result.data.length > 0) {
        const indianPornHQCategories = result.data
          .filter((cat: any) => cat.provider === 'indianpornhq' || !cat.provider)
          .map((cat: any) => ({
            ...cat,
            provider: 'indianpornhq'
          }))
        
        allCategories = [...indianPornHQCategories]
      }

      // Add FSIBlog categories
      const fsiblogCategories: ProviderCategory[] = [
        { name: 'Blowjob', url: 'https://www.fsiblog5.com/category/blowjob/', provider: 'fsiblog5' },
        { name: 'Couple', url: 'https://www.fsiblog5.com/category/couple/', provider: 'fsiblog5' },
        { name: 'Cuckold', url: 'https://www.fsiblog5.com/category/cuckold/', provider: 'fsiblog5' },
        { name: 'Nude Indian Girl', url: 'https://www.fsiblog5.com/category/nude-indian-girl/', provider: 'fsiblog5' },
        { name: 'Indian Wife', url: 'https://www.fsiblog5.com/category/indian-wife/', provider: 'fsiblog5' },
        { name: 'College Girl', url: 'https://www.fsiblog5.com/category/college-girl/', provider: 'fsiblog5' },
        { name: 'Aunty', url: 'https://www.fsiblog5.com/category/aunty/', provider: 'fsiblog5' },
        { name: 'Bhabhi', url: 'https://www.fsiblog5.com/category/bhabhi/', provider: 'fsiblog5' },
        { name: 'Desi MMS', url: 'https://www.fsiblog5.com/category/desi-mms/', provider: 'fsiblog5' },
        { name: 'Fingering', url: 'https://www.fsiblog5.com/category/fingering/', provider: 'fsiblog5' },
        { name: 'Lesbian', url: 'https://www.fsiblog5.com/category/lesbian/', provider: 'fsiblog5' },
        { name: 'Threesome', url: 'https://www.fsiblog5.com/category/threesome/', provider: 'fsiblog5' }
      ]

      allCategories = [...allCategories, ...fsiblogCategories]

      // Sort categories alphabetically by name
      allCategories.sort((a, b) => a.name.localeCompare(b.name))

      setCategories(allCategories)

      // Fetch thumbnails progressively for categories without them
      fetchCategoryThumbnails(allCategories)
    } catch (err) {
      console.error("Error loading categories:", err)
      setError("Failed to load categories. Please try again later.")
    } finally {
      setLoading(false)
    }
  }

  const fetchCategoryThumbnails = async (categoriesList: ProviderCategory[]) => {
    const batchSize = 6
    const categoriesToFetch = categoriesList.filter(cat => !cat.thumbnail)

    for (let i = 0; i < categoriesToFetch.length; i += batchSize) {
      const batch = categoriesToFetch.slice(i, i + batchSize)

      const thumbnails = await Promise.allSettled(
        batch.map(async (category) => {
          try {
            const cacheKey = `${category.provider}-category-thumbnail-${encodeURIComponent(category.url)}`
            const CACHE_DURATION = 12 * 60 * 60 * 1000 // 12 hours

            const cachedThumbnail = getCacheItem<string>(cacheKey)
            if (cachedThumbnail) {
              return { category, thumbnail: cachedThumbnail }
            }

            if (category.provider === 'fsiblog5') {
              // FSIBlog thumbnail fetching
              const slugMatch = category.url.match(/\/category\/([^/]+)\/?$/)
              if (!slugMatch) return { category, thumbnail: null }

              const categorySlug = slugMatch[1]
              const response = await fetch(`/api/providers/fsiblog5/category-videos?category=${categorySlug}`)
              const data = await response.json()

              if (data.success && data.videos && data.videos.length > 0) {
                const videoContent = data.videos.filter((v: any) =>
                  v.type === 'porn-video' || (!v.type && !v.title.toLowerCase().includes('gallery'))
                )

                if (videoContent.length > 0) {
                  let thumbnail = videoContent[0].thumbnail
                  if (thumbnail) {
                    thumbnail = `https://fsiblog5.premiumhub.workers.dev/?url=${encodeURIComponent(thumbnail)}`
                    setCacheItem(cacheKey, thumbnail, CACHE_DURATION)
                    return { category, thumbnail }
                  }
                }
              }
            } else {
              // IndianPornHQ thumbnail fetching
              const { fetchIndianPornHQCategoryVideos } = await import('@/services/api')
              const categoryVideos = await fetchIndianPornHQCategoryVideos(category.url)
              
              if (categoryVideos.success && categoryVideos.data && categoryVideos.data.length > 0) {
                const thumbnail = categoryVideos.data[0].thumbnail_url || categoryVideos.data[0].thumbnail
                if (thumbnail) {
                  setCacheItem(cacheKey, thumbnail, CACHE_DURATION)
                  return { category, thumbnail }
                }
              }
            }

            return { category, thumbnail: null }
          } catch (err) {
            console.error(`Error fetching thumbnail for ${category.name}:`, err)
            return { category, thumbnail: null }
          }
        })
      )

      // Update categories with fetched thumbnails
      setCategories((prev) => {
        const updated = [...prev]
        thumbnails.forEach((result) => {
          if (result.status === 'fulfilled' && result.value && result.value.thumbnail) {
            const categoryIndex = updated.findIndex((c) => c.url === result.value.category.url)
            if (categoryIndex !== -1) {
              updated[categoryIndex] = {
                ...updated[categoryIndex],
                thumbnail: result.value.thumbnail
              }
            }
          }
        })
        return updated
      })

      // Small delay between batches
      if (i + batchSize < categoriesToFetch.length) {
        await new Promise(resolve => setTimeout(resolve, 300))
      }
    }
  }

  useEffect(() => {
    loadAllCategories()
  }, [])

  // Filter categories based on search query
  const filteredCategories = categories.filter((category) =>
    category.name.toLowerCase().includes(searchQuery.toLowerCase())
  )

  return (
    <>
      <Head>
        <title>All Categories - PremiumHUB</title>
        <meta name="description" content="Browse all video categories from all providers on PremiumHUB." />
      </Head>

      <div className="pb-10 min-h-screen">
        <div className="container mx-auto px-4">
          {/* Header */}
          <div className="mb-8 pt-6">
            <h1 className="text-2xl sm:text-3xl md:text-4xl font-bold text-white mb-2 flex items-center">
              <Grid3x3 className="w-8 h-8 mr-3 text-purple-500" />
              All Categories
            </h1>
            <p className="text-sm sm:text-base text-gray-400 ml-11">Browse all categories from IndianPornHQ and FSIBlog</p>
          </div>

          {/* Search Bar */}
          <div className="mb-8">
            <div className="relative max-w-md">
              <input
                type="text"
                placeholder="Search categories..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="w-full px-4 py-3 pl-12 bg-gray-800/50 border border-gray-700/50 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:border-purple-500/50 transition-colors"
              />
              <Search className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
            </div>
            {searchQuery && (
              <p className="text-gray-400 text-sm mt-2">
                Found {filteredCategories.length} {filteredCategories.length === 1 ? 'category' : 'categories'}
              </p>
            )}
          </div>

          {/* Error message */}
          {error && (
            <div className="bg-red-500/10 border border-red-500/50 text-red-500 px-4 py-3 rounded-xl mb-6">
              {error}
            </div>
          )}

          {/* Categories grid */}
          {loading && categories.length === 0 ? (
            <div className="flex justify-center py-12">
              <div className="relative">
                <div className="animate-spin rounded-full h-16 w-16 border-4 border-purple-200 border-t-purple-600"></div>
                <div className="absolute inset-0 rounded-full border-4 border-purple-400/20"></div>
              </div>
            </div>
          ) : filteredCategories.length > 0 ? (
            <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
              {filteredCategories.map((category, index) => {
              {categories.map((category) => (
                <Link
                  key={category.slug}
                  href={`/category/${category.slug}`}
                  className="group relative aspect-square rounded-xl overflow-hidden transition-all duration-300 hover:scale-[1.03] shadow-lg shadow-black/30 hover:shadow-purple-900/20"
                >
                  <img
                    src={
                      category.imageUrl ||
                      `/api/placeholder?height=400&width=400&query=${encodeURIComponent(category.name)}%20videos`
                    }
                    alt={category.name}
                    className="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105 brightness-95"
                    onError={(e) => {
                      const target = e.target as HTMLImageElement
                      target.onerror = null
                      target.src = `/api/placeholder?height=400&width=400&query=${encodeURIComponent(category.name)}%20videos`
                    }}
                  />

                  <div className="absolute inset-0 bg-gradient-to-t from-black/90 to-black/30 opacity-70 group-hover:opacity-50 transition-opacity duration-300" />

                  <div className="absolute inset-0 flex flex-col items-center justify-center p-2 text-center">
                    <h3 className="text-sm sm:text-lg font-medium text-white group-hover:text-purple-300 transition-colors">
                      {category.name}
                    </h3>
                    <p className="text-xs sm:text-sm text-gray-300 mt-1">
                      <span className="bg-purple-600/80 text-white px-1.5 sm:px-2 py-0.5 rounded-md text-[10px] sm:text-xs">
                        {category.videoCount.toLocaleString()} videos
                      </span>
                    </p>
                  </div>
                </Link>
              ))}
            </div>
          ) : (
            <div className="text-center py-12 bg-gray-800/50 rounded-xl border border-gray-700/50 backdrop-blur-sm">
              <h3 className="text-xl font-medium text-gray-400">No categories found</h3>
              <p className="text-gray-500 mt-2">Please try again later.</p>
            </div>
          )}

          {/* Pagination */}
          {totalPages > 1 && (
            <div className="flex justify-center items-center space-x-2 mt-8">
              <button
                onClick={() => handlePageChange(currentPage - 1)}
                disabled={currentPage === 1 || loading}
                className="p-2 rounded-lg bg-gray-800/70 text-white hover:bg-purple-600/80 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                <ChevronLeft size={20} />
              </button>

              <div className="flex items-center space-x-1">
                {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                  // Show pages around current page
                  let pageNum
                  if (totalPages <= 5) {
                    pageNum = i + 1
                  } else if (currentPage <= 3) {
                    pageNum = i + 1
                  } else if (currentPage >= totalPages - 2) {
                    pageNum = totalPages - 4 + i
                  } else {
                    pageNum = currentPage - 2 + i
                  }

                  // Ensure pageNum is valid
                  if (pageNum < 1 || pageNum > totalPages) return null

                  return (
                    <button
                      key={pageNum}
                      onClick={() => handlePageChange(pageNum)}
                      disabled={loading}
                      className={`w-10 h-10 rounded-lg ${
                        currentPage === pageNum
                          ? "bg-purple-600 text-white"
                          : "bg-gray-800/70 text-white hover:bg-gray-700/80"
                      } disabled:opacity-50 disabled:cursor-not-allowed transition-colors`}
                    >
                      {pageNum}
                    </button>
                  )
                })}

                {totalPages > 5 && currentPage < totalPages - 2 && (
                  <>
                    <span className="text-gray-500">...</span>
                    <button
                      onClick={() => handlePageChange(totalPages)}
                      disabled={loading}
                      className="w-10 h-10 rounded-lg bg-gray-800/70 text-white hover:bg-gray-700/80 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                    >
                      {totalPages}
                    </button>
                  </>
                )}

                {/* Always show page 1 if not already visible and we're not on first few pages */}
                {totalPages > 5 && currentPage > 3 && (
                  <>
                    <button
                      onClick={() => handlePageChange(1)}
                      disabled={loading}
                      className="w-10 h-10 rounded-lg bg-gray-800/70 text-white hover:bg-gray-700/80 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                    >
                      1
                    </button>
                    <span className="text-gray-500">...</span>
                  </>
                )}
              </div>

              <button
                onClick={() => handlePageChange(currentPage + 1)}
                disabled={!hasNextPage || loading}
                className="p-2 rounded-lg bg-gray-800/70 text-white hover:bg-purple-600/80 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                <ChevronRight size={20} />
              </button>
            </div>
          )}
        </div>
      </div>
    </>
  )
}
